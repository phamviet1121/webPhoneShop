<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thêm khuyến mãi</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional: Bootstrap Icons for buttons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        /* Custom styles for a cleaner look */
        body {
            background-color: #f8f9fa; /* Light gray background */
        }
        .container {
            max-width: 900px; /* Limit form width for better readability */
        }
        .card-header {
            background-color: #0d6efd; /* Primary color header */
            color: white;
        }
        .price-display {
            font-size: 1.1rem;
            font-weight: 500;
        }
        .btn-primary, .btn-secondary {
            min-width: 120px; /* Give buttons a consistent width */
        }
    </style>
</head>
<body class="py-5">
    <div class="container">
        <div class="card shadow-sm">
            <div class="card-header">
                <h2 class="mb-0 text-white">Thiết lập Khuyến mãi Sản phẩm</h2>
            </div>
            <div class="card-body p-4">

                <!-- Error Message Display -->
                <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

                <!-- Form Start -->
                <form th:action="@{/phones/discount/save}" method="post" onsubmit="return validateBeforeSubmit()">
                    
                    <!-- Row 1: Chọn điện thoại -->
                    <div class="mb-4">
                        <label for="phoneId" class="form-label fw-bold">1. Chọn sản phẩm áp dụng</label>
                        <select class="form-select form-select-lg" id="phoneId" name="phoneId" required>
                            <option value="" disabled selected>-- Vui lòng chọn một điện thoại --</option>
                            <option th:each="phone : ${phones}" 
                                    th:value="${phone.id}" 
                                    th:data-stock="${phone.stock}"
                                    th:data-price="${phone.price}"
                                    th:text="${phone.name + ' - ' 
                                             + #numbers.formatInteger(phone.price,0,'COMMA') + ' VNĐ' 
                                             + ' - Tồn kho: ' + phone.stock}">
                            </option>
                        </select>
                    </div>

                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <!-- % Khuyến mãi -->
                            <div class="mb-3">
                                <label for="discount" class="form-label fw-bold">2. Mức khuyến mãi (%)</label>
                                <input type="number" id="discount" name="discountPercent" min="0" max="100" class="form-control" required placeholder="Ví dụ: 15">
                                <div class="form-text">Nhập phần trăm giảm giá cho sản phẩm.</div>
                            </div>

                             <!-- Số lượng áp dụng -->
                            <div class="mb-3">
                                <label for="quantity" class="form-label fw-bold">3. Số lượng sản phẩm khuyến mãi</label>
                                <input type="number" id="quantity" name="quantity" min="1" class="form-control" required placeholder="Ví dụ: 50">
                                <div class="form-text">Số lượng tối đa được áp dụng mức giá này.</div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-6">
                            <!-- Giá gốc -->
                            <div class="mb-3">
                                <label class="form-label text-muted">Giá gốc</label>
                                <input type="text" id="originalPrice" class="form-control-plaintext price-display text-danger" disabled value="Chưa xác định">
                            </div>

                            <!-- Giá sau khuyến mãi -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Giá sau khuyến mãi</label>
                                <input type="text" id="finalPrice" class="form-control-plaintext price-display text-success" disabled value="Chưa xác định">
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Row 3: Thời gian -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label fw-bold">4. Thời gian bắt đầu</label>
                            <input type="datetime-local" id="startTime" name="startTime" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endTime" class="form-label fw-bold">5. Thời gian kết thúc</label>
                            <input type="datetime-local" id="endTime" name="endTime" class="form-control" required>
                        </div>
                    </div>

                    <!-- Row 4: Trạng thái -->
                    <div class="mb-4">
                        <label for="status" class="form-label fw-bold">6. Trạng thái</label>
                        <select id="status" name="status" class="form-select" required>
                            <option value="ACTIVE">Đang áp dụng</option>
                            <option value="UPCOMING">Sắp diễn ra</option>
                            <option value="INACTIVE">Ngừng</option>
                        </select>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-end gap-2 border-top pt-4 mt-3">
                        <a th:href="@{/phones/index_Admin}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Hủy bỏ
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Lưu khuyến mãi
                        </button>
                    </div>
                </form>
                <!-- Form End -->
            </div>
        </div>
    </div>

    <!-- ======================= JAVASCRIPT LOGIC (No changes needed here) ======================= -->
    <script th:inline="javascript">
        /*<![CDATA[*/

        const promotionsData = /*[[${promotions}]]*/ [];
        const phoneSelect = document.getElementById("phoneId");
        const discountInput = document.getElementById("discount");
        const quantityInput = document.getElementById("quantity");
        const originalPriceInput = document.getElementById("originalPrice");
        const finalPriceInput = document.getElementById("finalPrice");
        const startTimeInput = document.getElementById("startTime");
        const endTimeInput = document.getElementById("endTime");
        const statusSelect = document.getElementById("status");

        phoneSelect.addEventListener("change", onPhoneChange);
        discountInput.addEventListener("input", updatePrice);
        quantityInput.addEventListener('input', validateQuantity);
        
        function onPhoneChange() {
            const selectedPhoneId = parseInt(phoneSelect.value);
            if (!selectedPhoneId) {
                clearFormFields();
                updatePrice();
                return;
            }

            const existingPromotion = promotionsData.find(p => p.phone.id === selectedPhoneId);

            if (existingPromotion) {
                fillFormWithData(existingPromotion);
            } else {
                clearFormFields();
            }
            updatePrice();
        }

        function fillFormWithData(promotion) {
            discountInput.value = promotion.discountPercent || 0;
            quantityInput.value = promotion.quantity || 1;
            statusSelect.value = promotion.status ? promotion.status.toUpperCase() : 'INACTIVE';
            startTimeInput.value = promotion.startTime ? promotion.startTime.slice(0, 16) : '';
            endTimeInput.value = promotion.endTime ? promotion.endTime.slice(0, 16) : '';
        }

        function clearFormFields() {
            discountInput.value = '';
            quantityInput.value = '';
            startTimeInput.value = '';
            endTimeInput.value = '';
            statusSelect.value = 'ACTIVE'; 
        }

        function updatePrice() {
            const selectedOption = phoneSelect.options[phoneSelect.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.price) {
                 originalPriceInput.value = 'Chưa xác định';
                 finalPriceInput.value = 'Chưa xác định';
                 return;
            }

            const originalPrice = parseFloat(selectedOption.dataset.price) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const finalPrice = originalPrice - (discount / 100) * originalPrice;

            originalPriceInput.value = originalPrice.toLocaleString("vi-VN") + " VNĐ";
            finalPriceInput.value = finalPrice.toLocaleString("vi-VN") + " VNĐ";
        }
        
        function validateQuantity() {
            const selectedOption = phoneSelect.options[phoneSelect.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.stock) return;

            const stock = parseInt(selectedOption.dataset.stock) || 0;
            const quantity = parseInt(quantityInput.value) || 0;

            if (quantity > stock) {
                alert("❌ Số lượng khuyến mãi không được vượt quá số lượng tồn kho (" + stock + ")");
                quantityInput.value = stock;
            }
        }
        
        function validateBeforeSubmit() {
            // Re-validate quantity on submit
            const selectedOption = phoneSelect.options[phoneSelect.selectedIndex];
            if(selectedOption && selectedOption.dataset.stock) {
                 const stock = parseInt(selectedOption.dataset.stock) || 0;
                 const quantity = parseInt(quantityInput.value) || 0;
                 if (quantity > stock) {
                     alert("❌ Số lượng khuyến mãi không được vượt quá số lượng tồn kho (" + stock + ")");
                     return false;
                 }
            }
            
            // Validate time
            const startTime = new Date(startTimeInput.value);
            const endTime = new Date(endTimeInput.value);

            if (!startTimeInput.value || !endTimeInput.value) {
                alert("❌ Vui lòng chọn cả thời gian bắt đầu và kết thúc.");
                return false;
            }

            if (endTime <= startTime) {
                alert("❌ Thời gian kết thúc phải diễn ra sau thời gian bắt đầu.");
                return false;
            }
            
            return true;
        }
        
        // Initialize the price display when the page loads
        document.addEventListener('DOMContentLoaded', updatePrice);

        /*]]>*/
    </script>

</body>
</html>