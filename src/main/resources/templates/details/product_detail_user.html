<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thông tin chi tiết sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/detail_user.css}">
    <style>
        /* (Các style CSS của bạn được giữ nguyên ở đây) */
        body {
            background-color: #f4f6f8;
            font-family: "Segoe UI", Roboto, sans-serif;
            margin-left: 260px; /* Thêm để không bị sidebar che */
        }
        .sidebar {
            width: 260px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(180deg, #1a1d23 0%, #2d3748 100%);
            color: #ffffff;
            padding: 30px 25px;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        .sidebar h3 {
            font-weight: 700;
            font-size: 1.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .sidebar .info-item { margin-bottom: 20px; }
        .sidebar .info-label { font-weight: 600; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px; }
        .sidebar .info-value { font-size: 1rem; color: #ffffff; }
        .sidebar a {
            color: #f8f9fa;
            text-decoration: none;
            display: block;
            background: rgba(255, 255, 255, 0.08);
            padding: 12px 18px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        .main-content {
            padding: 40px 30px;
        }
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            overflow: hidden;
            background: #ffffff;
            margin-bottom: 30px;
        }
        .product-image { text-align: center; padding: 30px; }
        .product-image img { max-width: 100%; max-height: 400px; border-radius: 12px; }
        .product-title { font-size: 2rem; font-weight: 700; color: #2563eb; margin-bottom: 20px; }
        .category-badge { display: inline-block; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; margin-bottom: 15px; }
        .price-container { display: flex; align-items: center; gap: 15px; margin: 20px 0; }
        .current-price { color: #dc2626; font-size: 2.2rem; font-weight: 700; }
        .original-price { color: #9ca3af; font-size: 1.3rem; text-decoration: line-through; }
        .discount-badge { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; }
        .stock-status { font-weight: 600; color: #10b981; }
        .btn { padding: 12px 28px; border-radius: 10px; font-weight: 600; border: none; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-secondary { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .description-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-top: 30px; }
        .description-box h5 { color: #1f2937; font-weight: 700; font-size: 1.3rem; }
        .description-box p, .description-box ul { color: #4b5563; }
        .rating-section h2 { font-weight: 700; font-size: 1.8rem; margin-bottom: 30px; color: #1f2937; border-bottom: 3px solid #2563eb; padding-bottom: 15px; }
        .rating-overview { display: flex; align-items: center; gap: 30px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; }
        .rating-score { font-size: 3.5rem; font-weight: 700; color: #d97706; }
        .rating-stars { color: #fbbf24; font-size: 1.5rem; }
        .rating-count { color: #6b7280; }
        .rating-distribution { width: 100%; max-width: 600px; }
        .rating-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .rating-label { min-width: 50px; font-weight: 600; color: #4b5563; }
        .rating-distribution .progress { flex: 1; height: 12px; background-color: #e5e7eb; border-radius: 8px; }
        .rating-distribution .progress-bar { background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%); }
        .rating-percent { min-width: 50px; text-align: right; font-weight: 600; color: #4b5563; }
        .review-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .review-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .review-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem; }
        .review-author { font-weight: 600; color: #1f2937; }
        .review-date { color: #9ca3af; font-size: 0.9rem; }
        .review-text { color: #4b5563; }
    </style>
</head>
<body class="bg-light">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h3> Thông tin người dùng </h3>
        <div class="info-item">
            <div class="info-label">Tên người dùng</div>
            <div class="info-value" th:text="${user.nameUser}"></th:text=></div>
        </div>
        <div class="info-item">
            <div class="info-label">Email người dùng</div>
            <div class="info-value"th:text="${user.gmailUser}"></th:text=></div>
        </div>
        
        <a th:href="@{/phones/index_User}" ><i class="bi bi-house-door"></i> Trang chủ </a>
        <a th:href="@{/orders/orders_list_User/{userId}(userId=${session.idUser})}"><i class="bi bi-grid"></i> Đợn hàng của tôi</a>
        <a th:href="@{/orders/carts_list_User_view/{userId}(userId=${session.idUser})}"><i class="bi bi-cart3"></i> Giỏ hàng</a>
        <!-- <a href="#"><i class="bi bi-person"></i> Tài khoản</a> -->
    </aside>

    <!-- Nội dung chính -->
    <main class="main-content">
        <div th:replace="~{fragments/headerIndex :: header(showLoginButton=false, extraNavItems=~{bits/nav-items :: searchBar_user})}"></div>

        <!-- Product Card -->
        <div class="card">
            <div class="row g-0">
                <!-- Product Image -->
                <div class="col-md-5">
                    <div class="product-image">
                        <img th:src="${phone.imageUrl}" alt="Ảnh điện thoại">
                    </div>
                </div>
                <!-- Product Info -->
                <div class="col-md-7">
                    <div class="card-body">
                        <!-- Cờ giảm giá góc trên trái - ACTIVE -->
                        <div th:if="${phoneInfo.DiscountPhone != null and phoneInfo.StatusDiscountPhone == 'active'}" 
                            class="position-absolute top-0 start-0 bg-danger text-white px-3 py-1 rounded-end mt-2 ms-2 shadow-sm"
                            style="font-weight: bold; font-size: 1rem;">
                            -<span th:text="${phoneInfo.DiscountPhone}"></span>%
                        </div>

                        <!-- Cờ giảm giá góc trên trái - UPCOMING -->
                        <div th:if="${phoneInfo.DiscountPhone != null and phoneInfo.StatusDiscountPhone == 'upcoming'}" 
                            class="position-absolute top-0 start-0 bg-warning text-dark px-3 py-1 rounded-end mt-2 ms-2 shadow-sm"
                            style="font-weight: bold; font-size: 0.9rem;">
                            -<span th:text="${phoneInfo.DiscountPhone}"></span>% ⏳
                        </div>
                        <h2 class="product-title" th:text="${phoneInfo.NamePhoneId}"></h2>

                        <div class="price-container">
                             <!-- ACTIVE -->
                            <div th:if="${phoneInfo.DiscountPhone != null and phoneInfo.StatusDiscountPhone == 'active'}">
                                <span class="text-decoration-line-through text-muted me-2"
                                    th:text="${#numbers.formatDecimal(phoneInfo.PricePhone, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span>
                                <span class="text-danger fw-bold fs-5"
                                    th:text="${#numbers.formatDecimal(phoneInfo.FinalPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span>
                            </div>

                            <!-- UPCOMING -->
                            <div th:if="${phoneInfo.DiscountPhone != null and phoneInfo.StatusDiscountPhone == 'upcoming'}" 
                                class="position-relative d-inline-block">
                                <!-- Giá gốc -->
                                <span class="fw-bold fs-5"
                                    th:text="${#numbers.formatDecimal(phoneInfo.PricePhone, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span>

                                <!-- Giá sau giảm nhỏ góc trên -->
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark"
                                    style="font-size: 0.75rem;"
                                    th:text="${
                                        phoneInfo.FinalPrice == null 
                                        ? #numbers.formatDecimal(phoneInfo.FinalPrice, 0, 'COMMA', 0, 'POINT') + ' VND' 
                                        : #numbers.formatDecimal(phoneInfo.PricePhone - (phoneInfo.DiscountPhone * phoneInfo.PricePhone / 100), 0, 'COMMA', 0, 'POINT') + ' VND'
                                    }">
                                </span>
                            </div>

                            <!-- INACTIVE / không có giảm -->
                            <div th:if="${phoneInfo.DiscountPhone == null or phoneInfo.StatusDiscountPhone == 'inactive'}">
                                <span class="fw-bold fs-5"
                                    th:text="${#numbers.formatDecimal(phoneInfo.PricePhone, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span>
                            </div>
                        </div>

                        <div class="stock-status">
                            <p>
                                <strong>Hãng:</strong>
                                <span th:text="${phoneInfo.BrandPhoneId}"></span>
                            </p>
                            <p>
                                <strong>Số lượng còn lại:</strong>
                                <span th:text="${phoneInfo.StockPhone}"></span>
                            </p>
                            <p>
                                <strong>Trạng thái:</strong>
                                <span th:text="${phoneInfo.StatusPhone}"></span>
                            </p>
                        </div>
                         <div th:if="${phoneInfo.DiscountPhone != null}" class="mb-3">
                            <p>
                                <strong>Thời gian khuyến mãi còn:</strong>
                                <span th:text="${phoneInfo.TimeDiscountphone}"></span>
                            </p>
                            <p>
                                <strong>Trạng thái khuyến mãi:</strong>
                                <span th:text="${phoneInfo.StatusDiscountPhone}"></span>
                            </p>
                        </div>
                        <hr class="my-4">
                        <div class="d-flex gap-3">
                            <form th:action="@{/phones/addCarIdUser/{id_phone}(id_phone=${phone.id})}"
                                method="post" style="display: inline;">

                                <button type="submit" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-cart-plus"></i>
                                </button>

                            </form>
                            <a th:href="@{/orders/buy/{id}(id=${phone.id})}" class="btn btn-success me-2">Mua</a>
                            <a href="javascript:void(0)" class="btn btn-secondary"
                                onclick="if (document.referrer) { window.history.back(); } else { window.location.href='/phones/index_User'; }">
                                ⬅ Quay lại
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description & Details -->
        <div class="card">
            <div class="card-body">
                <div class="description-box">
                    <h5><i class="bi bi-file-text"></i> Mô tả sản phẩm</h5>
                    <div th:utext="${phone.description}">
                        <!-- Nội dung mô tả từ database sẽ được chèn vào đây -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Rating Section -->
        <div class="col-12 mt-3">
                   
            <div class="review-list">  
                <h2><strong>Đánh giá điện thoại </strong><b><span th:text="${phone.name}"></span></b></h2>

                <div class="d-flex align-items-center mb-3 gap-4 flex-wrap">
                    <!-- Hình ảnh -->
                    <img th:src="${phone.imageUrl}" alt="Ảnh điện thoại" class="img-fluid rounded" style="max-width: 200px; height: auto;">
                

                    <div>
                        <p class="mb-1 fs-4 fw-semibold text-dark"><strong>Trung bình sao:</strong></p>
                        <div class="text-warning d-flex align-items-center gap-1 fs-5">
                            <div>
                                <!-- Sao vàng (filled stars) - chỉ hiển thị nếu avgRating > 0 -->
                                <span th:if="${avgRating > 0}"
                                        th:each="i : ${#numbers.sequence(1, T(java.lang.Math).floor(avgRating))}">
                                    <i class="bi bi-star-fill"></i>
                                </span>
                    
                                <!-- Sao trắng (empty stars) - chỉ hiển thị nếu avgRating < 5 -->
                                <span th:if="${avgRating < 5}"
                                        th:each="i : ${#numbers.sequence(T(java.lang.Math).floor(avgRating) + 1, 5)}">
                                    <i class="bi bi-star"></i>
                                </span>
                            </div>
                            <span class="ms-1">
                                (<span th:text="${#numbers.formatDecimal(avgRating, 1, 1)}"></span>)
                            </span>
                        </div>
                    </div>
                    
                    <div class="rating-distribution">
                        <div th:each="star : ${#numbers.sequence(5, 1)}" class="d-flex align-items-center mb-2">
                            <div class="rating-label me-2 text-warning fw-bold" th:text="${star} + ' ★'"></div>
                            <div class="progress flex-grow-1 me-2 w-100" style="height: 10px;">
                                <div class="progress-bar"
                                    role="progressbar"
                                    th:style="'width:' + (${ratingPercent[star.intValue()] != null ? ratingPercent[star.intValue()] : 0}) + '%'">
                                </div>
                            </div>
                            <div class="rating-percent" th:text="(${ratingPercent[star.intValue()] != null ? #numbers.formatDecimal(ratingPercent[star.intValue()], 1, 1) : '0.0'}) + '%'"></div>
                        </div>
                    </div>

                </div>


                
                
                <div class="card mb-3 shadow-sm p-3" th:each="reviewPhoneDetail, stat : ${reviewPhoneDetails}">
                    
                    <div class="row">
                        
        
                        <!-- Thông tin đánh giá -->
                        <div class="col-md-10">
                            <div class="row">
                                
                                <div class="col-md-4">
                                    
                                    <p><strong>Tên người dùng:</strong> <span th:text="${reviewPhoneDetail.username}"></span></p>
                               
                                    <p>
                                        <strong>Rating:</strong>
                                        <span class="text-warning">
                                            <!-- Hiển thị sao vàng (filled stars) -->
                                            <span th:each="i : ${#numbers.sequence(1, reviewPhoneDetail.rating)}">
                                                <i class="bi bi-star-fill"></i>
                                            </span>
                                    
                                            <!-- Hiển thị sao trắng (empty stars) nếu rating < 5 -->
                                            <span th:if="${reviewPhoneDetail.rating < 5}"
                                                    th:each="i : ${#numbers.sequence(reviewPhoneDetail.rating + 1, 5)}">
                                                <i class="bi bi-star"></i>
                                            </span>
                                    
                                            (<span th:text="${reviewPhoneDetail.rating}"></span>)
                                        </span>
                                    </p>
                                    
                                    
                                    <p><strong>Comment:</strong> <span th:text="${reviewPhoneDetail.comment}"></span></p>
                                </div>
                                
                                
                            </div>
        
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="http://localhost:8080/js/chatbot-loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>