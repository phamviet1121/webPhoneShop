<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gi·ªè H√†ng Mua S·∫Øm</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            background: #f7f7f7;
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        .cart-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15);
            transition: all 0.3s ease;
        }

        .product-img {
            width: 110px;
            height: 110px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .price-strike { text-decoration: line-through; color: #888; }
        .final-price { font-size: 18px; font-weight: bold; color: #d9534f; }
        .discount-percent { color: #0d6efd; font-weight: bold; margin-left: 6px; }

        .ad-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, .2);
            transition: 0.3s;
        }

        .btn-buy:active { transform: scale(0.98); }
        .btn-buy:hover { background-color: #0056b3; }

        /* V√πng scroll cho Voucher */
        .voucher-scroll {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 15px;
        }

        .voucher-scroll::-webkit-scrollbar { width: 6px; }
        .voucher-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .voucher-scroll::-webkit-scrollbar-thumb { background: #b8b8b8; border-radius: 10px; }
        .voucher-scroll::-webkit-scrollbar-thumb:hover { background: #8f8f8f; }

        /* === PHONG C√ÅCH COUPON M·ªöI - G·ªåN G√ÄNG H∆†N === */
        .coupon-card {
            position: relative;
            border-radius: 12px;
            background: linear-gradient(135deg, #6a82fb, #fc5c7d);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            color: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden; /* Gi·∫•u c√°c ph·∫ßn th·ª´a c·ªßa v·∫øt c·∫Øt */
        }

        .coupon-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.15);
        }

        /* V·∫øt c·∫Øt tr√≤n 2 b√™n */
        .coupon-card::before,
        .coupon-card::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background: #f7f7f7;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            margin-top: -10px; /* D·ªãch l√™n 1 ch√∫t ƒë·ªÉ v·∫øt c·∫Øt v√†o gi·ªØa ph·∫ßn tr√™n */
        }

        .coupon-card::before { left: -10px; }
        .coupon-card::after { right: -10px; }

        /* Ph·∫ßn ch√≠nh c·ªßa coupon */
        .coupon-main {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .coupon-discount-value {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
        }

        .coupon-info { flex-grow: 1; }
        .coupon-code {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 3px;
        }
        .coupon-description {
            font-size: 12px;
            opacity: 0.9;
        }
        .coupon-badge {
            position: absolute;
            top: 10px;
            right: 15px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.2);
        }

        /* Ph·∫ßn footer ch·ª©a chi ti·∫øt */
        .coupon-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 10px 20px 12px 20px;
            margin: 0 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.4);
        }

        .coupon-details, .coupon-meta {
            font-size: 11px;
            line-height: 1.5;
        }

        .coupon-details div { margin-bottom: 2px; }
        .coupon-meta { text-align: right; }
        .coupon-meta .status {
            font-weight: 700;
            text-transform: capitalize;
        }

    </style>
</head>

<body>

<div class="container py-4">

    <!-- HEADER -->
    <div class="text-center mb-4">
        <h1 class="fw-bold">To√†n b·ªô gi·ªè h√†ng (FULL DATA) c·ªßa t√¥i</h1>
        <p class="text-muted">Qu·∫£n l√Ω s·∫£n ph·∫©m v√† ho√†n t·∫•t ƒë∆°n h√†ng</p>
    </div>

    <div class="row g-4">

        <!-- LEFT: GI·ªé H√ÄNG -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">

                    <h4 class="mb-4 fw-bold d-flex align-items-center">
                        <svg width="26" height="26" fill="none" stroke="currentColor" class="me-2 text-primary"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0V19a2 2 0 002 2h7a2 2 0 002-2v-.5"/>
                        </svg>
                        S·∫£n ph·∫©m trong gi·ªè
                    </h4>

                    <div class="vstack gap-3">
                        <!-- LOOP CART ITEMS -->
                        <div th:each="item : ${cartPhones}"
                             class="card p-3 border-0 shadow-sm cart-item"
                             th:data-id="${item.PhoneDetail.PhoneId}"
                             th:data-stock="${item.PhoneDetail.StockPhone}"
                             th:data-original-price="${item.PhoneDetail.PricePhone}"
                             th:data-promo-qty="${item.PhoneDetail.QuantityPhone != null ? item.PhoneDetail.QuantityPhone : 0}"
                             th:data-is-promo="${item.PhoneDetail.StatusDiscountPhone == 'active'}">
                            <div class="row g-3 align-items-center">

                                <!-- Checkbox -->
                                <div class="col-auto">
                                    <input type="checkbox" class="form-check-input cart-check"
                                           th:data-id="${item.PhoneDetail.PhoneId}">
                                </div>

                                <!-- ·∫¢nh -->
                                <div class="col-auto">
                                    <img class="product-img" th:src="${item.PhoneDetail.ImageUrlPhoneId}">
                                </div>

                                <!-- Th√¥ng tin -->
                                <div class="col">
                                    <h5 class="fw-bold" th:text="${item.PhoneDetail.NamePhoneId}"></h5>
                                    <div><strong>ID:</strong> <span th:text="${item.PhoneDetail.PhoneId}"></span></div>
                                    <div><strong>H√£ng:</strong> <span th:text="${item.PhoneDetail.BrandPhoneId}"></span></div>
                                    <div><strong>T·ªìn kho:</strong> <span th:text="${item.PhoneDetail.StockPhone}"></span></div>
                                    <div th:if="${item.PhoneDetail.StatusDiscountPhone == 'active'}"><strong>S·ªë l∆∞·ª£ng khuy·∫øn m·∫°i:</strong> <span th:text="${item.PhoneDetail.QuantityPhone}"></span></div>

                                    <!-- Gi√° -->
                                    <div class="mt-2">
                                        <strong>Gi√°:</strong>
                                        <div class="ms-2 d-inline-block">
                                            <!-- Kh√¥ng gi·∫£m gi√° -->
                                            <div th:if="${item.PhoneDetail.DiscountPhone == null or item.PhoneDetail.DiscountPhone == 0 or item.PhoneDetail.StatusDiscountPhone == 'inactive'}">
                                                <span class="fw-bold text-primary price"
                                                      th:data-id="${item.PhoneDetail.PhoneId}"
                                                      th:data-price="${item.PhoneDetail.PricePhone}"
                                                      th:text="${#numbers.formatInteger(item.PhoneDetail.PricePhone,0,'COMMA')} + ' VNƒê'">
                                                </span>
                                            </div>
                                            <!-- Gi·∫£m gi√° ACTIVE -->
                                            <div th:if="${item.PhoneDetail.StatusDiscountPhone == 'active'}">
                                                <div class="final-price price"
                                                     th:data-id="${item.PhoneDetail.PhoneId}"
                                                     th:data-price="${item.PhoneDetail.FinalPrice}"
                                                     th:text="${#numbers.formatInteger(item.PhoneDetail.FinalPrice,0,'COMMA')} + ' VNƒê'">
                                                </div>
                                                <div>
                                                    <span class="price-strike"
                                                          th:text="${#numbers.formatInteger(item.PhoneDetail.PricePhone,0,'COMMA')} + ' VNƒê'"></span>
                                                    <span class="discount-percent"
                                                          th:text="'-' + ${item.PhoneDetail.DiscountPhone} + '%'"></span>
                                                </div>
                                            </div>
                                            <!-- UPCOMING -->
                                            <div th:if="${item.PhoneDetail.StatusDiscountPhone == 'upcoming'}">
                                                <span class="badge bg-secondary">S·∫Øp di·ªÖn ra</span>
                                                <div class="price"
                                                     th:data-id="${item.PhoneDetail.PhoneId}"
                                                     th:data-price="${item.PhoneDetail.PricePhone}"
                                                     th:text="${#numbers.formatInteger(item.PhoneDetail.PricePhone,0,'COMMA')} + ' VNƒê'">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- S·ªë l∆∞·ª£ng -->
                                <div class="col-auto">
                                    <div class="input-group" style="width:130px;">
                                        <button class="btn btn-outline-secondary btn-qty" data-type="minus" th:data-id="${item.PhoneDetail.PhoneId}">‚àí</button>
                                        <input type="text" class="form-control text-center cart-qty" th:data-id="${item.PhoneDetail.PhoneId}" th:value="${item.Quantity}" readonly>
                                        <button class="btn btn-outline-secondary btn-qty" data-type="plus" th:data-id="${item.PhoneDetail.PhoneId}">+</button>
                                    </div>
                                </div>
                                <!-- ‚úÖ N√öT X√ìA ƒê√É ƒê∆Ø·ª¢C DI CHUY·ªÇN V√ÄO TRONG ROW -->
                                <div class="col-auto">
                                    <form th:action="@{/phones/deleteCarIdUser/{id_phone}(id_phone=${item.PhoneDetail.PhoneId})}"
                                        method="post"
                                        onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?');">
                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="X√≥a s·∫£n ph·∫©m">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                                                <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm-2.038 1.858a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.528zM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5m3.5 0a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- T·ªïng thanh to√°n -->
                    <div class="mt-4 p-3 bg-light rounded shadow-sm">
                        <h5 class="fw-bold">T·ªïng thanh to√°n</h5>
                        <div class="d-flex justify-content-between mt-2">
                            <span>T·∫°m t√≠nh:</span>
                            <span id="subtotal" class="fw-bold">0 VNƒê</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fs-5 fw-bold">
                            <span>T·ªïng c·ªông:</span>
                            <span id="total" class="text-danger">0 VNƒê</span>
                        </div>
                        <button class="btn btn-primary w-100 mt-3 btn-buy">
                            Mua ngay (<span id="buyTotal">0</span>)
                        </button>
                    </div>
                    <!-- n√∫t quay l·∫°i  -->
                    <div class="mt-4 p-3 bg-light rounded shadow-sm">
                        <form th:action="@{/phones/index_User}" method="get">
                            <button type="submit" class="btn btn-primary w-100 mt-3"style="color: #000000; background: #c0c0c0;">
                                ‚Üê Quay l·∫°i
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Voucher + G·ª£i √Ω -->
        <div class="col-lg-4">
            <!-- Voucher -->
            <div class="card shadow-sm" style="height: 500px;">
                <div class="card-body d-flex flex-column">
                    <h5 class="fw-bold mb-3">M√£ gi·∫£m gi√°</h5>
                    <div class="voucher-scroll flex-grow-1">
                        <!-- LOOP VOUCHERS -->
                        <div th:each="vc : ${userVouchersinformation}" class="mb-3">
                            <div class="coupon-card">
                                <div class="coupon-badge" th:text="${vc.isUsed ? 'ƒê√£ d√πng' : 'Ch∆∞a d√πng'}"></div>
                                <div class="coupon-main">
                                    <div class="coupon-discount">
                                        <div class="coupon-discount-value" th:text="${vc.discountPercent} + '%'"></div>
                                    </div>
                                    <div class="coupon-info">
                                        <strong class="coupon-code" th:text="${vc.code}"></strong>
                                        <div class="coupon-description" th:text="${vc.description}"></div>
                                    </div>
                                </div>
                                <div class="coupon-footer">
                                    <div class="coupon-details">
                                        <div>‚Ä¢ ƒê∆°n t·ªëi thi·ªÉu: <span th:text="${#numbers.formatInteger(vc.minOrderValue, 0, 'COMMA')}"></span></div>
                                        <div>‚Ä¢ Gi·∫£m t·ªëi ƒëa: <span th:text="${#numbers.formatInteger(vc.maxDiscount, 0, 'COMMA')}"></span></div>
                                        <div>‚Ä¢ H·∫°n d√πng: <span th:text="${vc.expiredAt}"></span></div>
                                    </div>
                                    <div class="coupon-meta">
                                        <div>C√≤n: <b th:text="${vc.quantity}"></b></div>
                                        <div class="status" th:text="${vc.status}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- S·∫£n ph·∫©m ƒë·ªÅ xu·∫•t -->
            <div class="card shadow-sm mt-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">S·∫£n ph·∫©m ƒë·ªÅ xu·∫•t</h5>
                    <div class="vstack gap-3">
                        <div class="border rounded p-3 shadow-sm ad-card">
                            <div class="d-flex align-items-center gap-3">
                                <div class="fs-2">üì±</div>
                                <div>
                                    <div class="fw-semibold">iPad Air 2024</div>
                                    <div class="d-flex gap-2">
                                        <span class="fw-bold text-danger">14.990.000‚Ç´</span>
                                        <span class="text-muted text-decoration-line-through small">16.990.000‚Ç´</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100 mt-3">Th√™m v√†o gi·ªè</button>
                        </div>
                        <div class="border rounded p-3 shadow-sm ad-card">
                            <div class="d-flex align-items-center gap-3">
                                <div class="fs-2">‚åö</div>
                                <div>
                                    <div class="fw-semibold">Apple Watch Series 9</div>
                                    <div class="d-flex gap-2">
                                        <span class="fw-bold text-danger">9.990.000‚Ç´</span>
                                        <span class="text-muted text-decoration-line-through small">11.990.000‚Ç´</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100 mt-3">Th√™m v√†o gi·ªè</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="http://localhost:8080/js/chatbot-loader.js"></script>
<!-- SCRIPT -->
<script>
    function formatMoney(n) {
        return n.toLocaleString("vi-VN") + " VNƒê";
    }

    // L·∫•y gi√° c·ªßa s·∫£n ph·∫©m (∆∞u ti√™n gi√° khuy·∫øn m√£i n·∫øu c√≥)
    function getProductPrice(cartItem) {
        if (!cartItem) return 0;
        const priceEl = cartItem.querySelector(".price");
        return priceEl ? parseFloat(priceEl.dataset.price || 0) : 0;
    }
    
    // L·∫•y s·ªë l∆∞·ª£ng t·ª´ input
    function getProductQty(id) {
        const qtyEl = document.querySelector(`.cart-qty[data-id='${id}']`);
        if (!qtyEl) return 0;
        return parseInt(qtyEl.value || 0);
    }

    // === H√ÄM C·∫¨P NH·∫¨T T·ªîNG TI·ªÄN ƒê√É ƒê∆Ø·ª¢C VI·∫æT L·∫†I ===
    function updateTotal() {
        let subtotal = 0;
        document.querySelectorAll(".cart-check:checked").forEach(chk => {
            const id = chk.dataset.id;
            const cartItem = chk.closest('.cart-item');
            if (!cartItem) return;

            // L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu c·∫ßn thi·∫øt t·ª´ data-* attributes
            const selectedQty = getProductQty(id);
            const isPromo = cartItem.dataset.isPromo === 'true';
            const promoQty = parseInt(cartItem.dataset.promoQty || 0);
            const originalPrice = parseFloat(cartItem.dataset.originalPrice || 0);
            const finalPrice = getProductPrice(cartItem); // ƒê√¢y l√† gi√° ƒë√£ gi·∫£m

            let itemTotal = 0;

            // Logic t√≠nh gi√° h·ªón h·ª£p
            if (isPromo && promoQty > 0 && selectedQty > promoQty) {
                const promoPart = promoQty * finalPrice;
                const regularPart = (selectedQty - promoQty) * originalPrice;
                itemTotal = promoPart + regularPart;
                console.log(`ID ${id}: T√≠nh gi√° h·ªón h·ª£p - ${promoQty}*${finalPrice} + ${selectedQty - promoQty}*${originalPrice} = ${itemTotal}`);
            } else {
                // T√≠nh gi√° b√¨nh th∆∞·ªùng (ho·∫∑c l√† kh√¥ng c√≥ KM, ho·∫∑c s·ªë l∆∞·ª£ng mua trong gi·ªõi h·∫°n KM)
                itemTotal = selectedQty * finalPrice;
                console.log(`ID ${id}: T√≠nh gi√° th∆∞·ªùng - ${selectedQty}*${finalPrice} = ${itemTotal}`);
            }
            
            subtotal += itemTotal;
        });

        document.getElementById("subtotal").innerText = formatMoney(subtotal);
        document.getElementById("total").innerText = formatMoney(subtotal);
        document.getElementById("buyTotal").innerText = subtotal.toLocaleString("vi-VN");
    }

    // L·∫Øng nghe s·ª± ki·ªán click n√∫t tƒÉng/gi·∫£m s·ªë l∆∞·ª£ng
    document.querySelectorAll(".btn-qty").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const type = btn.dataset.type;
            const input = document.querySelector(`.cart-qty[data-id='${id}']`);
            const cartItem = btn.closest('.cart-item');
            const maxStock = parseInt(cartItem.dataset.stock || 0);

            let qty = parseInt(input.value || 1);

            if (type === "plus") {
                // Ch·ªâ tƒÉng n·∫øu ch∆∞a v∆∞·ª£t t·ªìn kho
                if (qty < maxStock) {
                    qty++;
                } else {
                    // C√≥ th·ªÉ th√™m th√¥ng b√°o cho ng∆∞·ªùi d√πng ·ªü ƒë√¢y
                    console.warn(`S·∫£n ph·∫©m ID ${id} ƒë√£ ƒë·∫°t s·ªë l∆∞·ª£ng t·ªìn kho t·ªëi ƒëa.`);
                }
            } else { // type === "minus"
                qty = Math.max(1, qty - 1);
            }
            
            input.value = qty;
            updateTotal();
        });
    });
    
    // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi checkbox
    document.querySelectorAll(".cart-check").forEach(chk => chk.addEventListener("change", updateTotal));

    // Ch·∫°y updateTotal l·∫ßn ƒë·∫ßu khi t·∫£i trang
    window.addEventListener("DOMContentLoaded", updateTotal);

    // X·ª≠ l√Ω n√∫t Mua Ngay
    document.querySelector(".btn-buy").addEventListener("click", () => {
        const selectedIds = Array.from(document.querySelectorAll(".cart-check:checked"))
            .map(chk => chk.dataset.id);
        if (!selectedIds.length) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m!");
            return;
        }
        window.location.href = "/orders/buylist?ids=" + selectedIds.join(",");
    });
</script>

</body>
</html>