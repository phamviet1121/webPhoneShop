<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh s√°ch ƒëi·ªán tho·∫°i</title>
</head>
<body>
<h2>Danh s√°ch ƒëi·ªán tho·∫°i v√† khuy·∫øn m√£i</h2>

<table border="1" cellpadding="5" cellspacing="0">
    <thead>
    <tr>
        <th>ID</th>
        <th>·∫¢nh</th>
        <th>T√™n</th>
        <th>H√£ng</th>
        <th>Gi√° g·ªëc</th>
        <th>Gi√° sau KM</th>
        <th>Khuy·∫øn m√£i (%)</th>
        <th>Tr·∫°ng th√°i KM</th>
        <th>S·ªë l∆∞·ª£ng KM</th>
        <th>Th·ªùi gian KM</th>
        <th>T·ªìn kho</th>
        <th>Tr·∫°ng th√°i ƒêT</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="p : ${phonesWithPromotions}">
        <td th:text="${p['PhoneId']}"></td>
        <td>
            <img th:src="${p['ImageUrlPhoneId']}" alt="·∫¢nh" width="80">
        </td>
        <td th:text="${p['NamePhoneId']}"></td>
        <td th:text="${p['BrandPhoneId']}"></td>
        <td th:text="${#numbers.formatInteger(p['PricePhone'],0,'COMMA') + ' ‚Ç´'}"></td>

        <td th:text="${#numbers.formatInteger(p['FinalPrice'],0,'COMMA') + ' ‚Ç´'}"></td>
        <td th:text="${p['DiscountPhone']}"></td>
        <td th:text="${p['StatusDiscountPhone']}"></td>
        <td th:text="${p['QuantityPhone']}"></td>
        <td th:text="${p['TimeDiscountphone']}"></td>
        <td th:text="${p['StockPhone']}"></td>
        <td th:text="${p['StatusPhone']}"></td>
    </tr>
    </tbody>
</table>
</body>
<!-- ////////////////////////// -->
 <div class="container py-4">

    <!-- HEADER -->
    <div class="text-center mb-4">
        <h1 class="fw-bold">To√†n b·ªô gi·ªè h√†ng (FULL DATA)</h1>
        <p class="text-muted">Qu·∫£n l√Ω s·∫£n ph·∫©m v√† ho√†n t·∫•t ƒë∆°n h√†ng</p>
    </div>

    <div class="row g-4">

        <!-- LEFT: GI·ªé H√ÄNG -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">

                    <h4 class="mb-4 fw-bold d-flex align-items-center">
                        <svg width="26" height="26" fill="none" stroke="currentColor" class="me-2 text-primary"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0V19a2 2 0 002 2h7a2 2 0 002-2v-.5"/>
                        </svg>
                        S·∫£n ph·∫©m trong gi·ªè
                    </h4>

                    <div class="vstack gap-3">
                        <!-- LOOP CART ITEMS -->
                        <div th:each="item : ${cartPhones}"
                             class="card p-3 border-0 shadow-sm cart-item"
                             th:data-id="${item.PhoneDetail.PhoneId}">
                            <div class="row g-3 align-items-center">

                                <!-- Checkbox -->
                                <div class="col-auto">
                                    <input type="checkbox" class="form-check-input cart-check"
                                           th:data-id="${item.PhoneDetail.PhoneId}">
                                </div>

                                <!-- ·∫¢nh -->
                                <div class="col-auto">
                                    <img class="product-img" th:src="${item.PhoneDetail.ImageUrlPhoneId}">
                                </div>

                                <!-- Th√¥ng tin + Gi√° -->
                                <div class="col">
                                    <h5 class="fw-bold" th:text="${item.PhoneDetail.NamePhoneId}"></h5>
                                    <div><strong>ID:</strong> <span th:text="${item.PhoneDetail.PhoneId}"></span></div>
                                    <div><strong>H√£ng:</strong> <span th:text="${item.PhoneDetail.BrandPhoneId}"></span></div>
                                    <div><strong>T·ªìn kho:</strong> <span th:text="${item.PhoneDetail.StockPhone}"></span></div>

                                    <div class="mt-2">
                                        <strong>Gi√°:</strong>
                                        <div class="ms-2 d-inline-block">

                                            <!-- Kh√¥ng gi·∫£m gi√° / Inactive -->
                                            <div th:if="${item.PhoneDetail.DiscountPhone == null
                                                        or item.PhoneDetail.DiscountPhone == 0
                                                        or item.PhoneDetail.StatusDiscountPhone == 'inactive'}">
                                                <span class="fw-bold text-primary price"
                                                      th:data-id="${item.PhoneDetail.PhoneId}"
                                                      th:data-price="${item.PhoneDetail.PricePhone}"
                                                      th:text="${#numbers.formatInteger(item.PhoneDetail.PricePhone,0,'COMMA')} + ' VNƒê'">
                                                </span>
                                            </div>

                                            <!-- Active Discount -->
                                            <div th:if="${item.PhoneDetail.StatusDiscountPhone == 'active'}">
                                                <div class="final-price price"
                                                     th:data-id="${item.PhoneDetail.PhoneId}"
                                                     th:data-price="${item.PhoneDetail.FinalPrice}"
                                                     th:text="${#numbers.formatInteger(item.PhoneDetail.FinalPrice,0,'COMMA')} + ' VNƒê'">
                                                </div>
                                                <div>
                                                    <span class="price-strike"
                                                          th:text="${#numbers.formatInteger(item.PhoneDetail.PricePhone,0,'COMMA')} + ' VNƒê'">
                                                    </span>
                                                    <span class="discount-percent"
                                                          th:text="'-' + ${item.PhoneDetail.DiscountPhone} + '%'"></span>
                                                </div>
                                            </div>

                                            <!-- Gi·∫£m gi√° UPCOMING -->
                                            <div th:if="${item.PhoneDetail.StatusDiscountPhone == 'upcoming'}">
                                                <div>
                                                    <span class="badge bg-warning text-dark price-display"
                                                        th:data-id="${item.PhoneDetail.PhoneId}"
                                                        th:text="${#numbers.formatInteger(
                                                            item.PhoneDetail.PricePhone * (100 - item.PhoneDetail.DiscountPhone) / 100,0,'COMMA')} + ' VNƒê'">
                                                    </span>
                                                    <span class="discount-percent"
                                                        th:text="'-' + ${item.PhoneDetail.DiscountPhone} + '%'"></span>
                                                </div>
                                                <div>
                                                    <span class="price" 
                                                        th:data-id="${item.PhoneDetail.PhoneId}" 
                                                        th:data-price="${item.PhoneDetail.PricePhone}" 
                                                        th:text="${#numbers.formatInteger(item.PhoneDetail.PricePhone,0,'COMMA')} + ' VNƒê'">
                                                    </span>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                </div>

                                <!-- S·ªë l∆∞·ª£ng -->
                                <div class="col-auto">
                                    <div class="input-group" style="width:130px;">
                                        <button class="btn btn-outline-secondary btn-qty"
                                                data-type="minus"
                                                th:data-id="${item.PhoneDetail.PhoneId}">‚àí</button>
                                        <input type="text" class="form-control text-center cart-qty"
                                               th:data-id="${item.PhoneDetail.PhoneId}"
                                               th:value="${item.Quantity}" readonly>
                                        <button class="btn btn-outline-secondary btn-qty"
                                                data-type="plus"
                                                th:data-id="${item.PhoneDetail.PhoneId}">+</button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- T·ªïng thanh to√°n -->
                    <div class="mt-4 p-3 bg-light rounded shadow-sm">
                        <h5 class="fw-bold">T·ªïng thanh to√°n</h5>
                        <div class="d-flex justify-content-between mt-2">
                            <span>T·∫°m t√≠nh:</span>
                            <span id="subtotal" class="fw-bold">0 VNƒê</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fs-5 fw-bold">
                            <span>T·ªïng c·ªông:</span>
                            <span id="total" class="text-danger">0 VNƒê</span>
                        </div>
                        <button class="btn btn-primary w-100 mt-3 btn-buy">
                            Mua ngay (<span id="buyTotal">0</span> VNƒê)
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- RIGHT: Voucher + G·ª£i √Ω -->
        <div class="col-lg-4">
            <!-- Voucher -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">M√£ gi·∫£m gi√°</h5>
                    <div class="vstack gap-3">
                        <div class="p-3 text-white rounded coupon-card"
                             style="background: linear-gradient(135deg,#667eea,#764ba2);">
                            <div class="d-flex justify-content-between">
                                <strong>SAVE20</strong>
                                <span class="badge bg-light text-dark">-20%</span>
                            </div>
                            <div class="small mt-2">Gi·∫£m 20% cho ƒë∆°n h√†ng t·ª´ 1 tri·ªáu</div>
                        </div>
                        <div class="p-3 text-white rounded coupon-card"
                             style="background: linear-gradient(135deg,#36d1dc,#5b86e5);">
                            <div class="d-flex justify-content-between">
                                <strong>FREESHIP</strong>
                                <span class="badge bg-light text-dark">-50K</span>
                            </div>
                            <div class="small mt-2">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn to√†n qu·ªëc</div>
                        </div>
                        <div class="p-3 text-white rounded coupon-card"
                             style="background: linear-gradient(135deg,#ff9966,#ff5e62);">
                            <div class="d-flex justify-content-between">
                                <strong>NEWUSER</strong>
                                <span class="badge bg-light text-dark">-15%</span>
                            </div>
                            <div class="small mt-2">∆Øu ƒë√£i cho kh√°ch h√†ng m·ªõi</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- S·∫£n ph·∫©m ƒë·ªÅ xu·∫•t -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">S·∫£n ph·∫©m ƒë·ªÅ xu·∫•t</h5>
                    <div class="vstack gap-3">
                        <div class="border rounded p-3 shadow-sm ad-card">
                            <div class="d-flex align-items-center gap-3">
                                <div class="fs-2">üì±</div>
                                <div>
                                    <div class="fw-semibold">iPad Air 2024</div>
                                    <div class="d-flex gap-2">
                                        <span class="fw-bold text-danger">14.990.000‚Ç´</span>
                                        <span class="text-muted text-decoration-line-through small">16.990.000‚Ç´</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100 mt-3">Th√™m v√†o gi·ªè</button>
                        </div>
                        <div class="border rounded p-3 shadow-sm ad-card">
                            <div class="d-flex align-items-center gap-3">
                                <div class="fs-2">‚åö</div>
                                <div>
                                    <div class="fw-semibold">Apple Watch Series 9</div>
                                    <div class="d-flex gap-2">
                                        <span class="fw-bold text-danger">9.990.000‚Ç´</span>
                                        <span class="text-muted text-decoration-line-through small">11.990.000‚Ç´</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100 mt-3">Th√™m v√†o gi·ªè</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- END RIGHT -->

    </div>
</div>

<!-- SCRIPT T√çNH TI·ªÄN + MUA NGAY -->
<script>
    function formatMoney(n) {
        return n.toLocaleString("vi-VN") + " VNƒê";
    }

    function getProductPrice(id) {
        const item = document.querySelector(`.cart-item[data-id='${id}']`);
        if (!item) return 0;
        const finalEl = item.querySelector(".final-price[data-id='" + id + "']");
        if (finalEl) return parseFloat(finalEl.dataset.price || 0);
        const priceEl = item.querySelector(".price[data-id='" + id + "']");
        if (priceEl) return parseFloat(priceEl.dataset.price || 0);
        return 0;
    }

    function getProductQty(id) {
        const qtyEl = document.querySelector(`.cart-qty[data-id='${id}']`);
        if (!qtyEl) return 0;
        const qty = parseInt(qtyEl.value || 0);
        return isNaN(qty) ? 0 : qty;
    }

    function updateTotal() {
        let subtotal = 0;
        document.querySelectorAll(".cart-check:checked").forEach(chk => {
            const id = chk.dataset.id;
            subtotal += getProductPrice(id) * getProductQty(id);
        });
        document.getElementById("subtotal").innerText = formatMoney(subtotal);
        document.getElementById("total").innerText = formatMoney(subtotal);
        document.getElementById("buyTotal").innerText = formatMoney(subtotal);
    }

    // C·∫≠p nh·∫≠t t·ªïng khi ch·ªçn checkbox ho·∫∑c thay ƒë·ªïi s·ªë l∆∞·ª£ng
    document.querySelectorAll(".cart-check").forEach(chk => chk.addEventListener("change", updateTotal));
    document.querySelectorAll(".btn-qty").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const type = btn.dataset.type;
            const input = document.querySelector(`.cart-qty[data-id='${id}']`);
            if (!input) return;
            let qty = parseInt(input.value || 1);
            qty = type === "minus" ? Math.max(1, qty - 1) : qty + 1;
            input.value = qty;
            updateTotal();
        });
    });

    window.addEventListener("DOMContentLoaded", updateTotal);

    // X·ª≠ l√Ω n√∫t Mua ngay
    document.querySelector(".btn-buy").addEventListener("click", () => {
        const selectedIds = Array.from(document.querySelectorAll(".cart-check:checked"))
            .map(chk => chk.dataset.id);
        if (selectedIds.length === 0) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!");
            return;
        }
         // Chuy·ªÉn h∆∞·ªõng sang trang /orders/buylist k√®m c√°c id s·∫£n ph·∫©m
        const url = "/orders/buylist?ids=" + selectedIds.join(",");
        window.location.href = url;
    });
</script>